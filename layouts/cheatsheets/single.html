{{ define "main" }}
<section class="container mx-auto px-4 py-8">
  <!-- Breadcrumb Navigation -->
  <div class="mb-6">
    <nav class="flex" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="/" class="inline-flex items-center text-sm font-medium text-primary dark:text-darkmode-primary hover:underline">
            <i class="fas fa-home mr-2"></i>
            Home
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
            <a href="/cheatsheets/" class="text-sm font-medium text-primary dark:text-darkmode-primary hover:underline">Cheatsheets</a>
          </div>
        </li>
        {{ with .Params.folder }}
        <li>
          <div class="flex items-center">
            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
            <a href="/cheatsheets/{{ . | urlize }}/" class="text-sm font-medium text-primary dark:text-darkmode-primary hover:underline">{{ . }}</a>
          </div>
        </li>
        {{ end }}
        <li aria-current="page">
          <div class="flex items-center">
            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
            <span class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ .Title }}</span>
          </div>
        </li>
      </ol>
    </nav>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
    <!-- Left Section: Table of Contents -->
    <aside class="lg:col-span-1">
      <div class="sticky top-24 p-6 bg-theme-light dark:bg-darkmode-theme-light rounded-lg shadow-lg border-0 toc-container" id="toc-container">
        <div class="toc-header">
          <h4>
            <i class="fas fa-list-ul"></i>
            Table of Contents
          </h4>
          <button class="toc-toggle" id="toc-toggle" aria-label="Toggle table of contents">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
        <nav id="TableOfContents" class="toc-nav">{{ .TableOfContents }}</nav>
      </div>
    </aside>

    <!-- TOC Toggle Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Get TOC elements
        const tocContainer = document.getElementById('toc-container');
        const tocToggle = document.getElementById('toc-toggle');
        const tocNav = document.getElementById('TableOfContents');

        // Add toggle functionality
        tocToggle.addEventListener('click', function() {
          tocContainer.classList.toggle('toc-collapsed');
        });

        // Add active class to current section
        const addActiveClass = function() {
          // Get all headings in the content
          const headings = document.querySelectorAll('main h1, main h2, main h3, main h4, main h5, main h6');

          // Get all links in the TOC
          const tocLinks = document.querySelectorAll('#TableOfContents a');

          // Remove all active classes first
          tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.parentElement.classList.contains('active')) {
              link.parentElement.classList.remove('active');
            }
          });

          // Find the current section in view
          let currentSection = '';
          headings.forEach(heading => {
            const rect = heading.getBoundingClientRect();
            if (rect.top <= 100 && rect.bottom >= 100) {
              currentSection = '#' + heading.id;
            }
          });

          // Add active class to the current section in TOC
          if (currentSection) {
            const activeLink = document.querySelector(`#TableOfContents a[href="${currentSection}"]`);
            if (activeLink) {
              activeLink.classList.add('active');
              let parent = activeLink.parentElement;
              while (parent && parent.id !== 'TableOfContents') {
                if (parent.tagName === 'LI') {
                  parent.classList.add('active');
                }
                parent = parent.parentElement;
              }
            }
          }
        };

        // Add has-children class to list items with nested lists
        const listItems = document.querySelectorAll('#TableOfContents li');
        listItems.forEach(item => {
          if (item.querySelector('ul')) {
            item.classList.add('has-children');
          }
        });

        // Add smooth scrolling to TOC links
        const tocLinks = document.querySelectorAll('#TableOfContents a');
        tocLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);

            if (targetElement) {
              // Highlight the target element briefly
              targetElement.classList.add('toc-highlight');
              setTimeout(() => {
                targetElement.classList.remove('toc-highlight');
              }, 2000);

              // Smooth scroll to the target
              window.scrollTo({
                top: targetElement.offsetTop - 80,
                behavior: 'smooth'
              });

              // Update URL without scrolling
              history.pushState(null, null, targetId);
            }
          });
        });

        // Call on scroll and on load
        window.addEventListener('scroll', addActiveClass);
        addActiveClass();
      });
    </script>

    <!-- Right Section: Content and Quizzes -->
    <main class="lg:col-span-3 space-y-8">
      <!-- Main Content -->
      <div class="bg-theme-light dark:bg-darkmode-theme-light rounded-lg shadow-lg overflow-hidden">
        <article class="p-6">
          <!-- Categories Section -->
          {{ with .Params.cheatsheet_categories }}
          <div class="mb-4">
            <span class="inline-flex items-center text-text dark:text-darkmode-text">
              <i class="fas fa-folder-open mr-2"></i>
              {{ range . }}
              <a href="{{ "cheatsheet_categories/" | relLangURL }}{{ . | urlize }}" class="ml-2 text-primary dark:text-darkmode-primary hover:underline">
                {{ . }}
              </a>
              {{ end }}
            </span>
          </div>
          {{ end }}

          <h1 class="text-h1-sm md:text-h1 font-bold mb-6 text-text dark:text-darkmode-text font-primary">
            {{ .Title }}
          </h1>

          <!-- Display featured image if available -->
          {{ $image:= .Params.image }}
          {{ if $image }}
          <div class="mb-8">
            {{ partial "image" (dict "Src" $image "Alt" .Title "Class" "rounded-lg w-full h-auto max-h-96 object-contain" "Size" "800x400") }}
          </div>
          {{ end }}
          <div class="prose dark:prose-invert max-w-none">
            {{ .Content }}
          </div>

          <!-- Tags Section -->
          {{ with .Params.cheatsheet_tags }}
          <div class="mt-6 pt-4 border-t border-border dark:border-darkmode-border">
            <span class="inline-flex items-center flex-wrap text-text dark:text-darkmode-text">
              <i class="fas fa-tags mr-2"></i>
              Tags:
              {{ range . }}
              <a href="{{ "cheatsheet_tags/" | relLangURL }}{{ . | urlize }}" class="ml-2 bg-theme dark:bg-darkmode-theme px-2 py-1 rounded-full text-sm hover:bg-primary hover:text-white transition-colors duration-200 mb-2">
                {{ . }}
              </a>
              {{ end }}
            </span>
          </div>
          {{ end }}
        </article>
      </div>

      <!-- Quiz Section -->
      {{ if or .Params.quiz .Params.wordfill }}
      <div class="space-y-8">
        <!-- ... existing quiz section code ... -->
      </div>
      {{ end }}
    </main>
  </div>
</section>

<!-- Load quiz scripts at the end -->
{{ if .Params.quiz }}
<script src="{{ "js/wordguess.js" | relURL }}?code={{ .Params.quiz.code }}"></script>
{{ end }}
{{ if .Params.wordfill }}
<script src="{{ "js/wordfill.js" | relURL }}?code={{ .Params.wordfill.code }}"></script>
{{ end }}
{{ end }}
